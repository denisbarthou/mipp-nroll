SRCS=kernels/k_1x1x1.cpp kernels/k_1x2x1.cpp kernels/k_1x3x1.cpp kernels/k_1x4x1.cpp kernels/k_1x5x1.cpp kernels/k_1x6x1.cpp kernels/k_1x7x1.cpp kernels/k_1x8x1.cpp kernels/k_1x9x1.cpp kernels/k_1x10x1.cpp kernels/k_1x11x1.cpp kernels/k_1x12x1.cpp kernels/k_1x13x1.cpp kernels/k_1x14x1.cpp kernels/k_1x1x2.cpp kernels/k_1x2x2.cpp kernels/k_1x3x2.cpp kernels/k_1x4x2.cpp kernels/k_1x5x2.cpp kernels/k_1x6x2.cpp kernels/k_1x7x2.cpp kernels/k_1x8x2.cpp kernels/k_1x9x2.cpp kernels/k_1x10x2.cpp kernels/k_1x11x2.cpp kernels/k_1x12x2.cpp kernels/k_1x13x2.cpp kernels/k_1x14x2.cpp kernels/k_1x1x3.cpp kernels/k_1x2x3.cpp kernels/k_1x3x3.cpp kernels/k_1x4x3.cpp kernels/k_1x5x3.cpp kernels/k_1x6x3.cpp kernels/k_1x7x3.cpp kernels/k_1x8x3.cpp kernels/k_1x9x3.cpp kernels/k_1x10x3.cpp kernels/k_1x11x3.cpp kernels/k_1x12x3.cpp kernels/k_1x13x3.cpp kernels/k_1x14x3.cpp kernels/k_1x1x4.cpp kernels/k_1x2x4.cpp kernels/k_1x3x4.cpp kernels/k_1x4x4.cpp kernels/k_1x5x4.cpp kernels/k_1x6x4.cpp kernels/k_1x7x4.cpp kernels/k_1x8x4.cpp kernels/k_1x9x4.cpp kernels/k_1x10x4.cpp kernels/k_1x11x4.cpp kernels/k_1x12x4.cpp kernels/k_1x1x5.cpp kernels/k_1x2x5.cpp kernels/k_1x3x5.cpp kernels/k_1x4x5.cpp kernels/k_1x5x5.cpp kernels/k_1x6x5.cpp kernels/k_1x7x5.cpp kernels/k_1x8x5.cpp kernels/k_1x9x5.cpp kernels/k_1x1x6.cpp kernels/k_1x2x6.cpp kernels/k_1x3x6.cpp kernels/k_1x4x6.cpp kernels/k_1x5x6.cpp kernels/k_1x6x6.cpp kernels/k_1x7x6.cpp kernels/k_1x8x6.cpp kernels/k_1x1x7.cpp kernels/k_1x2x7.cpp kernels/k_1x3x7.cpp kernels/k_1x4x7.cpp kernels/k_1x5x7.cpp kernels/k_1x6x7.cpp kernels/k_1x7x7.cpp kernels/k_1x1x8.cpp kernels/k_1x2x8.cpp kernels/k_1x3x8.cpp kernels/k_1x4x8.cpp kernels/k_1x5x8.cpp kernels/k_1x6x8.cpp kernels/k_1x1x9.cpp kernels/k_1x2x9.cpp kernels/k_1x3x9.cpp kernels/k_1x4x9.cpp kernels/k_1x5x9.cpp kernels/k_1x1x10.cpp kernels/k_1x2x10.cpp kernels/k_1x3x10.cpp kernels/k_1x4x10.cpp kernels/k_1x1x11.cpp kernels/k_1x2x11.cpp kernels/k_1x3x11.cpp kernels/k_1x4x11.cpp kernels/k_1x1x12.cpp kernels/k_1x2x12.cpp kernels/k_1x3x12.cpp kernels/k_1x4x12.cpp kernels/k_1x1x13.cpp kernels/k_1x2x13.cpp kernels/k_1x3x13.cpp kernels/k_1x1x14.cpp kernels/k_1x2x14.cpp kernels/k_1x3x14.cpp kernels/k_2x1x1.cpp kernels/k_2x2x1.cpp kernels/k_2x3x1.cpp kernels/k_2x4x1.cpp kernels/k_2x5x1.cpp kernels/k_2x6x1.cpp kernels/k_2x7x1.cpp kernels/k_2x8x1.cpp kernels/k_2x9x1.cpp kernels/k_2x10x1.cpp kernels/k_2x11x1.cpp kernels/k_2x12x1.cpp kernels/k_2x13x1.cpp kernels/k_2x14x1.cpp kernels/k_2x1x2.cpp kernels/k_2x2x2.cpp kernels/k_2x3x2.cpp kernels/k_2x4x2.cpp kernels/k_2x5x2.cpp kernels/k_2x6x2.cpp kernels/k_2x7x2.cpp kernels/k_2x8x2.cpp kernels/k_2x9x2.cpp kernels/k_2x10x2.cpp kernels/k_2x11x2.cpp kernels/k_2x12x2.cpp kernels/k_2x13x2.cpp kernels/k_2x14x2.cpp kernels/k_2x1x3.cpp kernels/k_2x2x3.cpp kernels/k_2x3x3.cpp kernels/k_2x4x3.cpp kernels/k_2x5x3.cpp kernels/k_2x6x3.cpp kernels/k_2x7x3.cpp kernels/k_2x8x3.cpp kernels/k_2x9x3.cpp kernels/k_2x10x3.cpp kernels/k_2x11x3.cpp kernels/k_2x1x4.cpp kernels/k_2x2x4.cpp kernels/k_2x3x4.cpp kernels/k_2x4x4.cpp kernels/k_2x5x4.cpp kernels/k_2x6x4.cpp kernels/k_2x7x4.cpp kernels/k_2x8x4.cpp kernels/k_2x9x4.cpp kernels/k_2x1x5.cpp kernels/k_2x2x5.cpp kernels/k_2x3x5.cpp kernels/k_2x4x5.cpp kernels/k_2x5x5.cpp kernels/k_2x6x5.cpp kernels/k_2x7x5.cpp kernels/k_2x1x6.cpp kernels/k_2x2x6.cpp kernels/k_2x3x6.cpp kernels/k_2x4x6.cpp kernels/k_2x5x6.cpp kernels/k_2x6x6.cpp kernels/k_2x1x7.cpp kernels/k_2x2x7.cpp kernels/k_2x3x7.cpp kernels/k_2x4x7.cpp kernels/k_2x5x7.cpp kernels/k_2x1x8.cpp kernels/k_2x2x8.cpp kernels/k_2x3x8.cpp kernels/k_2x4x8.cpp kernels/k_2x1x9.cpp kernels/k_2x2x9.cpp kernels/k_2x3x9.cpp kernels/k_2x4x9.cpp kernels/k_2x1x10.cpp kernels/k_2x2x10.cpp kernels/k_2x3x10.cpp kernels/k_2x1x11.cpp kernels/k_2x2x11.cpp kernels/k_2x3x11.cpp kernels/k_2x1x12.cpp kernels/k_2x2x12.cpp kernels/k_2x1x13.cpp kernels/k_2x2x13.cpp kernels/k_2x1x14.cpp kernels/k_2x2x14.cpp kernels/k_3x1x1.cpp kernels/k_3x2x1.cpp kernels/k_3x3x1.cpp kernels/k_3x4x1.cpp kernels/k_3x5x1.cpp kernels/k_3x6x1.cpp kernels/k_3x7x1.cpp kernels/k_3x8x1.cpp kernels/k_3x9x1.cpp kernels/k_3x10x1.cpp kernels/k_3x11x1.cpp kernels/k_3x12x1.cpp kernels/k_3x13x1.cpp kernels/k_3x14x1.cpp kernels/k_3x1x2.cpp kernels/k_3x2x2.cpp kernels/k_3x3x2.cpp kernels/k_3x4x2.cpp kernels/k_3x5x2.cpp kernels/k_3x6x2.cpp kernels/k_3x7x2.cpp kernels/k_3x8x2.cpp kernels/k_3x9x2.cpp kernels/k_3x10x2.cpp kernels/k_3x11x2.cpp kernels/k_3x1x3.cpp kernels/k_3x2x3.cpp kernels/k_3x3x3.cpp kernels/k_3x4x3.cpp kernels/k_3x5x3.cpp kernels/k_3x6x3.cpp kernels/k_3x7x3.cpp kernels/k_3x8x3.cpp kernels/k_3x9x3.cpp kernels/k_3x1x4.cpp kernels/k_3x2x4.cpp kernels/k_3x3x4.cpp kernels/k_3x4x4.cpp kernels/k_3x5x4.cpp kernels/k_3x6x4.cpp kernels/k_3x7x4.cpp kernels/k_3x1x5.cpp kernels/k_3x2x5.cpp kernels/k_3x3x5.cpp kernels/k_3x4x5.cpp kernels/k_3x5x5.cpp kernels/k_3x6x5.cpp kernels/k_3x1x6.cpp kernels/k_3x2x6.cpp kernels/k_3x3x6.cpp kernels/k_3x4x6.cpp kernels/k_3x5x6.cpp kernels/k_3x1x7.cpp kernels/k_3x2x7.cpp kernels/k_3x3x7.cpp kernels/k_3x4x7.cpp kernels/k_3x1x8.cpp kernels/k_3x2x8.cpp kernels/k_3x3x8.cpp kernels/k_3x1x9.cpp kernels/k_3x2x9.cpp kernels/k_3x3x9.cpp kernels/k_3x1x10.cpp kernels/k_3x2x10.cpp kernels/k_3x1x11.cpp kernels/k_3x2x11.cpp kernels/k_3x1x12.cpp kernels/k_3x1x13.cpp kernels/k_3x1x14.cpp kernels/k_4x1x1.cpp kernels/k_4x2x1.cpp kernels/k_4x3x1.cpp kernels/k_4x4x1.cpp kernels/k_4x5x1.cpp kernels/k_4x6x1.cpp kernels/k_4x7x1.cpp kernels/k_4x8x1.cpp kernels/k_4x9x1.cpp kernels/k_4x10x1.cpp kernels/k_4x11x1.cpp kernels/k_4x12x1.cpp kernels/k_4x1x2.cpp kernels/k_4x2x2.cpp kernels/k_4x3x2.cpp kernels/k_4x4x2.cpp kernels/k_4x5x2.cpp kernels/k_4x6x2.cpp kernels/k_4x7x2.cpp kernels/k_4x8x2.cpp kernels/k_4x9x2.cpp kernels/k_4x1x3.cpp kernels/k_4x2x3.cpp kernels/k_4x3x3.cpp kernels/k_4x4x3.cpp kernels/k_4x5x3.cpp kernels/k_4x6x3.cpp kernels/k_4x7x3.cpp kernels/k_4x1x4.cpp kernels/k_4x2x4.cpp kernels/k_4x3x4.cpp kernels/k_4x4x4.cpp kernels/k_4x5x4.cpp kernels/k_4x6x4.cpp kernels/k_4x1x5.cpp kernels/k_4x2x5.cpp kernels/k_4x3x5.cpp kernels/k_4x4x5.cpp kernels/k_4x1x6.cpp kernels/k_4x2x6.cpp kernels/k_4x3x6.cpp kernels/k_4x4x6.cpp kernels/k_4x1x7.cpp kernels/k_4x2x7.cpp kernels/k_4x3x7.cpp kernels/k_4x1x8.cpp kernels/k_4x2x8.cpp kernels/k_4x1x9.cpp kernels/k_4x2x9.cpp kernels/k_4x1x10.cpp kernels/k_4x1x11.cpp kernels/k_4x1x12.cpp kernels/k_5x1x1.cpp kernels/k_5x2x1.cpp kernels/k_5x3x1.cpp kernels/k_5x4x1.cpp kernels/k_5x5x1.cpp kernels/k_5x6x1.cpp kernels/k_5x7x1.cpp kernels/k_5x8x1.cpp kernels/k_5x9x1.cpp kernels/k_5x1x2.cpp kernels/k_5x2x2.cpp kernels/k_5x3x2.cpp kernels/k_5x4x2.cpp kernels/k_5x5x2.cpp kernels/k_5x6x2.cpp kernels/k_5x7x2.cpp kernels/k_5x1x3.cpp kernels/k_5x2x3.cpp kernels/k_5x3x3.cpp kernels/k_5x4x3.cpp kernels/k_5x5x3.cpp kernels/k_5x6x3.cpp kernels/k_5x1x4.cpp kernels/k_5x2x4.cpp kernels/k_5x3x4.cpp kernels/k_5x4x4.cpp kernels/k_5x1x5.cpp kernels/k_5x2x5.cpp kernels/k_5x3x5.cpp kernels/k_5x1x6.cpp kernels/k_5x2x6.cpp kernels/k_5x3x6.cpp kernels/k_5x1x7.cpp kernels/k_5x2x7.cpp kernels/k_5x1x8.cpp kernels/k_5x1x9.cpp kernels/k_6x1x1.cpp kernels/k_6x2x1.cpp kernels/k_6x3x1.cpp kernels/k_6x4x1.cpp kernels/k_6x5x1.cpp kernels/k_6x6x1.cpp kernels/k_6x7x1.cpp kernels/k_6x8x1.cpp kernels/k_6x1x2.cpp kernels/k_6x2x2.cpp kernels/k_6x3x2.cpp kernels/k_6x4x2.cpp kernels/k_6x5x2.cpp kernels/k_6x6x2.cpp kernels/k_6x1x3.cpp kernels/k_6x2x3.cpp kernels/k_6x3x3.cpp kernels/k_6x4x3.cpp kernels/k_6x5x3.cpp kernels/k_6x1x4.cpp kernels/k_6x2x4.cpp kernels/k_6x3x4.cpp kernels/k_6x4x4.cpp kernels/k_6x1x5.cpp kernels/k_6x2x5.cpp kernels/k_6x3x5.cpp kernels/k_6x1x6.cpp kernels/k_6x2x6.cpp kernels/k_6x1x7.cpp kernels/k_6x1x8.cpp kernels/k_7x1x1.cpp kernels/k_7x2x1.cpp kernels/k_7x3x1.cpp kernels/k_7x4x1.cpp kernels/k_7x5x1.cpp kernels/k_7x6x1.cpp kernels/k_7x7x1.cpp kernels/k_7x1x2.cpp kernels/k_7x2x2.cpp kernels/k_7x3x2.cpp kernels/k_7x4x2.cpp kernels/k_7x5x2.cpp kernels/k_7x1x3.cpp kernels/k_7x2x3.cpp kernels/k_7x3x3.cpp kernels/k_7x4x3.cpp kernels/k_7x1x4.cpp kernels/k_7x2x4.cpp kernels/k_7x3x4.cpp kernels/k_7x1x5.cpp kernels/k_7x2x5.cpp kernels/k_7x1x6.cpp kernels/k_7x1x7.cpp kernels/k_8x1x1.cpp kernels/k_8x2x1.cpp kernels/k_8x3x1.cpp kernels/k_8x4x1.cpp kernels/k_8x5x1.cpp kernels/k_8x6x1.cpp kernels/k_8x1x2.cpp kernels/k_8x2x2.cpp kernels/k_8x3x2.cpp kernels/k_8x4x2.cpp kernels/k_8x1x3.cpp kernels/k_8x2x3.cpp kernels/k_8x3x3.cpp kernels/k_8x1x4.cpp kernels/k_8x2x4.cpp kernels/k_8x1x5.cpp kernels/k_8x1x6.cpp kernels/k_9x1x1.cpp kernels/k_9x2x1.cpp kernels/k_9x3x1.cpp kernels/k_9x4x1.cpp kernels/k_9x5x1.cpp kernels/k_9x1x2.cpp kernels/k_9x2x2.cpp kernels/k_9x3x2.cpp kernels/k_9x4x2.cpp kernels/k_9x1x3.cpp kernels/k_9x2x3.cpp kernels/k_9x3x3.cpp kernels/k_9x1x4.cpp kernels/k_9x2x4.cpp kernels/k_9x1x5.cpp kernels/k_10x1x1.cpp kernels/k_10x2x1.cpp kernels/k_10x3x1.cpp kernels/k_10x4x1.cpp kernels/k_10x1x2.cpp kernels/k_10x2x2.cpp kernels/k_10x3x2.cpp kernels/k_10x1x3.cpp kernels/k_10x2x3.cpp kernels/k_10x1x4.cpp kernels/k_11x1x1.cpp kernels/k_11x2x1.cpp kernels/k_11x3x1.cpp kernels/k_11x4x1.cpp kernels/k_11x1x2.cpp kernels/k_11x2x2.cpp kernels/k_11x3x2.cpp kernels/k_11x1x3.cpp kernels/k_11x2x3.cpp kernels/k_11x1x4.cpp kernels/k_12x1x1.cpp kernels/k_12x2x1.cpp kernels/k_12x3x1.cpp kernels/k_12x4x1.cpp kernels/k_12x1x2.cpp kernels/k_12x2x2.cpp kernels/k_12x1x3.cpp kernels/k_12x1x4.cpp kernels/k_13x1x1.cpp kernels/k_13x2x1.cpp kernels/k_13x3x1.cpp kernels/k_13x1x2.cpp kernels/k_13x2x2.cpp kernels/k_13x1x3.cpp kernels/k_14x1x1.cpp kernels/k_14x2x1.cpp kernels/k_14x3x1.cpp kernels/k_14x1x2.cpp kernels/k_14x2x2.cpp kernels/k_14x1x3.cpp 
CFLAGS=-finline -std=c++17 -fPIC -O3 -I. -I../../../../MIPP/src -march=native  -DMIPP_ALIGNED_LOADS # -DLIKWID_PERFMON
LDFLAGS= # -DLIKWID_PERFMON -llikwid

run: run.c
	clang -o $@ $^ -L. -ldl
## Generic rules
%.dat: %.time %.spill %.reg
	paste  $^ > $@
%.pdf: %.plot %.dat
	gnuplot $<
%.time: libkernels.%.so run
	./run `basename $@ .time` 2>&1 |sort > $@
#       likwid-perfctr -C S1 -g FLOPS_DP -m ./run `basename $@ .time` 2>&1 1> log | sort >  $@

%.gcc.o: %.cpp
	g++ $^ -c -fpermissive ${CFLAGS} -o $@ 
%.icc.o: %.cpp
	icpc $^ -c -qopt-zmm-usage=high -inline-forceinline ${CFLAGS} -o $@ 
%.ll: %.cpp
	clang++ $^ -S -emit-llvm -o $@ ${CFLAGS} #-DLIKWID_PERFMON
%.pbqp.o:%.ll
	llc -O3 --regalloc=pbqp --relocation-model=pic $^ -filetype=obj -o $@
%.greedy.o:%.ll
	llc -O3 --regalloc=greedy --relocation-model=pic $^ -filetype=obj -o $@
%.basic.o:%.ll
	llc -O3 --regalloc=basic --relocation-model=pic $^ -filetype=obj -o $@
%.reg: %.o
	@objdump -d $^|sed -e 's/%\(zmm[0-9]*\)/\n@\1\n/g'|grep "@"| sort -u|wc -l|xargs -I{} echo `basename $^ .o`" {}" > $@
%.spill: %.o
	@objdump -d $^|grep rsp|grep \%zmm|sed -e 's/.*[ ,]\([^ ]*\)(\%rsp).*/\1/'|sort -u|wc -l|xargs -I{} echo `basename $^ .o`" {}" > $@
rdtsc.o: rdtsc.c
	gcc -o $@ -c $^ -fPIC
libkernels.icc.so: $(SRCS:.cpp=.icc.o)
	icpc -shared $^ -o $@
libkernels.gcc.so: $(SRCS:.cpp=.gcc.o) rdtsc.o
	g++ -shared $^ -o $@
libkernels.pbqp.so: $(SRCS:.cpp=.pbqp.o)
	clang++ -shared $^ -o $@ #-DLIKWID_PERFMON -llikwid
libkernels.greedy.so: $(SRCS:.cpp=.greedy.o)
	clang++ -shared $^ -o $@ 
libkernels.basic.so: $(SRCS:.cpp=.basic.o)
	clang++ -shared $^ -o $@ #-DLIKWID_PERFMON -llikwid

icc.reg: $(SRCS:.cpp=.icc.reg)
	cat $^|sort > $@
icc.spill: $(SRCS:.cpp=.icc.spill)
	cat $^|sort > $@

gcc.reg: $(SRCS:.cpp=.gcc.reg)
	cat $^|sort > $@
gcc.spill: $(SRCS:.cpp=.gcc.spill)
	cat $^|sort > $@

greedy.reg: $(SRCS:.cpp=.greedy.reg)
	cat $^|sort > $@
greedy.spill: $(SRCS:.cpp=.greedy.spill)
	cat $^|sort > $@

basic.reg: $(SRCS:.cpp=.basic.reg)
	cat $^|sort > $@
basic.spill: $(SRCS:.cpp=.basic.spill)
	cat $^|sort > $@

pbqp.reg: $(SRCS:.cpp=.pbqp.reg)
	cat $^|sort > $@
pbqp.spill: $(SRCS:.cpp=.pbqp.spill)
	cat $^|sort > $@

fast.reg: $(SRCS:.cpp=.fast.reg)
	cat $^|sort > $@
fast.spill: $(SRCS:.cpp=.fast.spill)
	cat $^|sort > $@

